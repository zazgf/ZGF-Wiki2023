<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>毫米波和摄像机融合 - ZGF Wiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u6beb\u7c73\u6ce2\u548c\u6444\u50cf\u673a\u878d\u5408";
    var mkdocs_page_input_path = "\u6beb\u7c73\u6ce2\u548c\u6444\u50cf\u673a\u878d\u5408.md";
    var mkdocs_page_url = "/\u6beb\u7c73\u6ce2\u548c\u6444\u50cf\u673a\u878d\u5408/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ZGF Wiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../c++/">C++</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../python/">Python</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../ubuntu18/">Ubuntu18</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Ros/">Ros</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Ros建模/">Ros建模</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../tf_document/">tf_document</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../caffe/">Caffe</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../deeplearning/">deeplearning</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../voxelnet/">voxelnet</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../radar_camera_fusion/">radar_camera</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../python有用的函数/">python有用的函数(一)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../OpenCV/">OpenCV</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../harbor/">Harbor</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Atlas200验收报告/">Atlas200验收报告</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../激光雷达算法盒子/">激光雷达算法盒子</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../radar_camera_fusion/">radar_camera_fusion</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">毫米波和摄像机融合</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#_1">简介</a></li>
    

    <li class="toctree-l2"><a href="#_2">环境要求</a></li>
    

    <li class="toctree-l2"><a href="#_3">软件环境部署</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#qt">QT安装</a></li>
        
        </ul>
    

    <li class="toctree-l2"><a href="#ros-melodic">ROS melodic 安装</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#cuda100-cudnn">Cuda10.0 ，cudnn安装</a></li>
        
        </ul>
    

    <li class="toctree-l2"><a href="#ars404">ARS404的应用</a></li>
    

    <li class="toctree-l2"><a href="#_4">毫米波和图像的融合</a></li>
    

    <li class="toctree-l2"><a href="#_5">摄像头标定</a></li>
    

    <li class="toctree-l2"><a href="#darknet">darknet</a></li>
    

    <li class="toctree-l2"><a href="#_6">如何提取出距离信息</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#_7">毫米波单目深度融合(深度学习)</a></li>
        
            <li><a class="toctree-l3" href="#_8">输入</a></li>
        
            <li><a class="toctree-l3" href="#_9">神经网络推理</a></li>
        
            <li><a class="toctree-l3" href="#_10">输出</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ZGF Wiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>毫米波和摄像机融合</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h3 id="_1">简介</h3>
<p>毫米波和单目融合的研究，通过融合视觉的识别特性和毫米波的测距特性，实现目标识别和测距功能。更深层次可以通过深度学习提取出深度信息。</p>
<h2 id="_2">环境要求</h2>
<ul>
<li>Ubuntu 18.04</li>
<li>Cuda 10.0</li>
<li>ROS melodic</li>
<li>Qt5</li>
</ul>
<h2 id="_3">软件环境部署</h2>
<h3 id="qt">QT安装</h3>
<ul>
<li>sudo apt-get install qttools5-dev-tools libqt5svg5-dev qtmultimedia5-dev</li>
</ul>
<h2 id="ros-melodic">ROS melodic 安装</h2>
<p><a href="http://wiki.ros.org/melodic/Installation/Ubuntu">ROS官网</a></p>
<h3 id="cuda100-cudnn">Cuda10.0 ，cudnn安装</h3>
<p><a href="https://www.cnblogs.com/journeyonmyway/p/10316292.html">安装指南</a></p>
<p>把程序包里的 <code>radar</code>文件夹拷贝到本地</p>
<p><img alt="" src="../images/Screenshot2021-05-1011:41:00.png" /></p>
<p>在此目录下，执行 <code>catkin_make</code> 指令</p>
<p><img alt="" src="../images/Screenshot2021-05-1011:48:17.png" /></p>
<p>编译完成后，指令输入</p>
<pre><code class="language-bash">sudo ip link set can0 up type can bitrate 500000
roslaunch ars_40X ars_40X.launch
</code></pre>
<p>在设备链接正常的情况下就可看到输出</p>
<p><img alt="" src="../images/Screenshot2021-05-1011:52:52.png" /></p>
<h2 id="ars404">ARS404的应用</h2>
<pre><code class="language-bash">cansend can0 200#F8000000089C0000 // Objects detection with all extended properties
cansend can0 200#F8000000109C0000 // Clusters detection with all extended properties
</code></pre>
<p>这两条指令分别启动radar的 Cluster模式和Object模式，我们使用Object模式，（cluster模式）</p>
<p><img alt="" src="../images/Screenshot2021-05-1108:48:39.png" /></p>
<p><em>毫米波雷达数据是二维数据，只有x, y 坐标信息， 显示如上图</em></p>
<p>毫米波雷达数据读取，我们使用 <code>ars_40X</code>程序</p>
<p>数据显示和图像显示，我们使用 <code>ros2qt</code> 程序</p>
<p>图像物体识别，我们使用 <code>vision_darknet_detect</code> 程序</p>
<h2 id="_4">毫米波和图像的融合</h2>
<ul>
<li>首先对摄像头进行标定</li>
<li>获取内参矩阵</li>
<li>通过内参矩阵把毫米波数据映射到图像上</li>
<li>通过yolo识别，并提取出物体距离，如下图</li>
</ul>
<p><img alt="" src="../images/Screenshot2021-05-1013:48:30.png" /></p>
<h2 id="_5">摄像头标定</h2>
<p>摄像头标定可以使用opencv提供的标定方法，也可以使用matlab提供的摄像头标定插件。</p>
<p>我们介绍下matlab摄像头标定方法。为了方便标定，我们制作了两个”标定盒子”</p>
<p><img alt="" src="../images/1464317228.jpg" /></p>
<p><img alt="" src="../images/1746943194.jpg" /></p>
<p>通过该摄像头依次采集如下位置图片位于image文件夹</p>
<p><img alt="" src="../images/1.jpg" /></p>
<p><img alt="" src="../images/2.jpg" /></p>
<p><img alt="" src="../images/3.jpg" /></p>
<p><img alt="" src="../images/4.jpg" /></p>
<p><img alt="" src="../images/5.jpg" /></p>
<p><img alt="" src="../images/6.jpg" /></p>
<p><img alt="" src="../images/7.jpg" /></p>
<p><img alt="" src="../images/8.jpg" /></p>
<p><img alt="" src="../images/9.jpg" /></p>
<p><img alt="" src="../images/10.jpg" /></p>
<p><img alt="" src="../images/11.jpg" /></p>
<p><img alt="" src="../images/12.jpg" /></p>
<p><img alt="" src="../images/13.jpg" /></p>
<p><img alt="" src="../images/14.jpg" /></p>
<p><img alt="" src="../images/15.jpg" /></p>
<p><img alt="" src="../images/16.jpg" /></p>
<p><img alt="" src="../images/17.jpg" /></p>
<p><img alt="" src="../images/18.jpg" /></p>
<p><img alt="" src="../images/19.jpg" /></p>
<p><img alt="" src="../images/20.jpg" /></p>
<p><img alt="" src="../images/21.jpg" /></p>
<p><img alt="" src="../images/22.jpg" /></p>
<p><img alt="" src="../images/23.jpg" /></p>
<p><img alt="" src="../images/24.jpg" /></p>
<p><img alt="" src="../images/25.jpg" /></p>
<p><img alt="" src="../images/26.jpg" /></p>
<p><img alt="" src="../images/27.jpg" /></p>
<p><img alt="" src="../images/28.jpg" /></p>
<p><img alt="" src="../images/29.jpg" /></p>
<p><img alt="" src="../images/30.jpg" /></p>
<p>在matlab 应用程序下找到Camera Calibration工具箱</p>
<p><img alt="" src="../images/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTYwMzMxMTAxNjAzOTY5.png" /></p>
<p>加载待标定的图像</p>
<p><img alt="" src="../images/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTYwMzMxMTAxNjMwMzEy.png" /></p>
<p>填写棋盘格每个格子边长的真实值</p>
<p><img alt="" src="../images/33.png" /></p>
<p>可以预览成功检测出棋盘格的图像，然后开始标定，点击Calibrate</p>
<p><img alt="" src="../images/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTYwMzMxMTAxNjQ3MzU5.png" /></p>
<p>平均误差小于0.5即可</p>
<p><img alt="" src="../images/31.png" /></p>
<p>导出相机标定参数</p>
<p><img alt="" src="../images/32.png" /></p>
<p>我们只需要用到 <strong>IntrinsicMatrix</strong></p>
<pre><code class="language-cpp">cv::Point World2Image(Eigen::Vector3d Pw)
{
  static Eigen::Matrix3d intric = (Eigen::Matrix3d() &lt;&lt; 465.2203, 0, 351.1325, 0, 463.8023, 256.4198, 0, 0, 1).finished();
  static Eigen::Matrix3d mi = (Eigen::Matrix3d() &lt;&lt; 1, 0, 0, 0, -1,0, 0, 0, 1).finished();
  Pw = mi*Pw;
  Eigen::VectorXd result(2);
  result = intric*Pw/Pw.z();
  cv::Point P (result(0),result(1));
  return P;
}
</code></pre>
<p>通过world2image函数把毫米波坐标系转换到图像坐标系</p>
<p>这样在图像中，我们就有了深度信息。</p>
<p>然后再通过yolo的darknet进行物体识别，就可得到，障碍物的类别和距离信息。</p>
<p>这里需要注意的是，我们的摄像头和毫米波安装位置关系，由于毫米波只有x，y信息，没有高度信息，所以我们尽量保持摄像头和毫米波竖直方向上中心线重合。</p>
<p>备注，如果想要更改摄像头和毫米波的相对位置，只需通过刚性变换矩阵，进行坐标系转换</p>
<p>$<script type="math/tex; mode=display">\begin{bmatrix}cos(\theta)&-sin(\theta)&0.0&x\\sin(\theta)&cos(\theta)&0.0&y\\0.0&0.0&1.0&z\\0.0&0.0&0.0&1.0\end{bmatrix}</script>$</p>
<p>变换矩阵里$<script type="math/tex; mode=display">\begin{bmatrix}cos(\theta)&-sin(\theta)&0.0\\sin(\theta)&cos(\theta)&0.0\\0.0&0.0&1.0\end{bmatrix}</script>$是3x3旋转矩阵，xyz是平移矩阵。</p>
<p>只需更改对应的旋转平移参数，即可进行坐标系转换。</p>
<h2 id="darknet">darknet</h2>
<p><a href="https://pjreddie.com/darknet/yolo/">Yolo物体检测</a></p>
<p>我们在程序里使用了yolo v3进行物体识别</p>
<p><img alt="" src="../images/Screen_Shot_2018-03-24_at_10.48.42_PM.png" /></p>
<h2 id="_6">如何提取出距离信息</h2>
<p>我们已经把毫米波的距离信息投影到了图片上，同时，我们用yolo对障碍物进行了识别分类，画出了边界框。</p>
<p>我们只需要把边界框内部的距离信息提取出来即可。由于毫米波有误差，所以我们需要对这些边界框里的信息进行筛选。在一般情况下，摄像头可以直接检测到的物体，说明此物体前面没有障碍物，因为光是直线传播的。也就是说如果障碍物前方还有有障碍物，摄像头很大可能就看不到后面那一个，但是毫米波可能通过漫反射看到了，产生多个距离信息。所以，我们就可以提取边界框里的最小距离当做识别障碍物的距离。这同样是出于安全考虑，需要选择距离最近的距离。</p>
<p><em>我们可以根据性能要求，提出更好的提取深度信息方法。</em></p>
<p><img alt="" src="../images/Screenshot2021-05-1108:42:10.png" /></p>
<p><em>图中灰色的点是毫米波投射到图像上的点，黄色的框是yolo识别的边界框</em></p>
<p>整个算法的具体实现逻辑可以阅读程序包里完整的程序。</p>
<p><strong>预测碰撞时间，udp。</strong></p>
<h3 id="_7">毫米波单目深度融合(深度学习)</h3>
<p><strong>环境</strong></p>
<ul>
<li>Ubuntu 18.04</li>
<li>Cuda 10.0</li>
<li>Pytorch 1.3.1</li>
<li>Python 3.6.5</li>
</ul>
<p>使用 <strong>radar_depth</strong>深度神经网络,参见<a href="https://github.com/brade31919/radar_depth">网址</a></p>
<p>环境搭建
深度融合的基础是我们上面的数据级融合。
第一步，把程序包里的 <code>radar_depth</code> 文件夹拷贝到本地</p>
<pre><code class="language-bash">cd radar_depth

pip install -r requirement.txt
</code></pre>
<p>安装过程中如果出现要求版本的库缺失，例如 <code>nuscenes-devkit 1.1.5</code>
可以单独安装</p>
<pre><code class="language-bash">pip install nuscenes-devkit==1.1.5
</code></pre>
<p>环境搭建完后，更改config/config_nuscenes.py. 处的项目设置</p>
<pre><code class="language-python">PROJECT_ROOT = &quot;YOUR_PATH/radar_depth&quot;
DATASET_ROOT = &quot;DATASET_PATH&quot;
</code></pre>
<p>可以对该神经网络架构进行深入研究 <a href="https://arxiv.org/pdf/2010.00058.pdf">pdf</a></p>
<p>接下来，我们需要准备神经网络输入数据（图片和雷达数据）运行神经网络推理，得到输出数据。</p>
<h3 id="_8">输入</h3>
<p><img alt="" src="../images/pic.jpg" /></p>
<ul>
<li>雷达数据 。。。</li>
</ul>
<p>输入数据准备，需要利用程序包里 <code>radar/src/ars_40X/src/ros/deal_data4net.cpp</code> 节点来制造神经网络输入数据。</p>
<p>先启动数据采集</p>
<pre><code class="language-bash">sudo ip link set can0 up type can bitrate 500000

roslaunch ars_40X ars_40X.launch

rosrun ars_40X deal_data4net

</code></pre>
<p>运行会存档一张图片 <code>pic.jpg</code> 和 雷达数据 <code>result.csv</code></p>
<h3 id="_9">神经网络推理</h3>
<p>我们使用 MyFun.py脚本进行推理</p>
<pre><code class="language-python">im = Image.open('/home/promote/pic.jpg') # 为图像读取接口
。。。
with open('/home/promote/result.csv', newline='') as f: #为雷达读取接口
</code></pre>
<p>只需修改为本地正确的路径</p>
<p><strong>推理</strong></p>
<pre><code class="language-bash">python MyFun.py \
--evaluate /home/username/radar_depth/pretrained/resnet18_multistage.pth.tar \
--data nuscenes \
--arch resnet18_multistage_uncertainty_fixs \
--modality rgbd \
--sparsifier radar \
--decoder upproj
</code></pre>
<h3 id="_10">输出</h3>
<p><img alt="" src="../images/comparison_my.png" />
<img alt="" src="../images/Screenshot2021-05-2817:02:28.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../radar_camera_fusion/" class="btn btn-neutral" title="radar_camera_fusion"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../radar_camera_fusion/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../mathjaxhelper.js"></script>

</body>
</html>
